/** @file lateral_Control_VREP.hpp
 *  @brief The header file for lateral controller implementation when using IMACS framework with VREP simulator
 */
#ifndef LANEDETECTION_LATERAL_CONTROL_VREP_H_
#define LANEDETECTION_LATERAL_CONTROL_VREP_H_

#include <Eigen/Eigen>
#include "paths.hpp"
#include "lkas_model.hpp"

#define MAX_SCENARIOS 9 //!< maximum number of scenarios defined
#define LENGTH_PHI_AUG 6 //!< length of the phi_aug matrix of the controller.
/// @brief Class for lateral controller. The VREP simulator model is scaled down (10:1) for faster simulation, i.e. 10m in real world = 1m in simulator.
class lateralControllerVREP : lkasModel {
private:
    // member variables
    std::vector<long double> m_input = std::vector<long double> (400); /// the control input. Stored as a list (inefficient).[TO DO: convert from vector<long double> to long double for delay <= h]
    long double m_desired_steering_angle; /// computed steering angle

    /// Controller matrices. Note that the Matrix dimensions need to be changed depending on the type of controller and controller implementation choice.
    std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, LENGTH_PHI_AUG> > m_phi_aug
                                        = std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, LENGTH_PHI_AUG> > (MAX_SCENARIOS);  /// controller phi_aug matrices
    std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, LENGTH_PHI_AUG> > m_T
                                        = std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, LENGTH_PHI_AUG> > (MAX_SCENARIOS);  /// controller T matrices from controllability decomposition function ctrbf()
    std::vector< Eigen::Matrix<long double, 1, (LENGTH_PHI_AUG-1)> > m_K2c
                                        = std::vector< Eigen::Matrix<long double, 1, (LENGTH_PHI_AUG-1)> > (MAX_SCENARIOS);  /// controller controllable gain matrices after controllability decomposition
    std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, 1> > m_Gamma_aug
                                        = std::vector< Eigen::Matrix<long double, LENGTH_PHI_AUG, 1> > (MAX_SCENARIOS); /// controller Gamma_aug matrices
public:
    vector<float> period_s; 	/// sampling period in seconds
    vector<float> tau_s; 	/// sensor-to-actuator delay in seconds

    /**  @brief C++ implementation of the controller that computes the steering angle for the LKAS represented by the m_phi_aug and m_Gamma_aug matrices using the gain matrix m_K2c and the decomposition transformation matrix m_T
         @param[in] the_yL           	Lateral Deviation at the look-ahead distance. Since the system is SISO, only one state is needed as input
         @param[in] the_it_counter	The iteration counter that keeps track of the k-th instance
	 @param[in] scenario		The scenario to simulate
	 @note the function updates the class member m_desired_steering_angle
      */
    void compute_steering_angle(long double the_yL, int the_it_counter, int scenario);

    /**  @brief Function to access the steering angle from outside the class
	 @return the m_desired_steering_angle.
      */
    long double get_steering_angle();

    /**  @brief C++ implementation of a simple estimator
         @param[in] the_it_counter	The iteration counter that keeps track of the k-th instance
	 @param[in] scenario		The scenario to simulate
	 @note the function updates the m_input and (derived) states of the system m_zi
      */
    void estimate_next_state(int the_it_counter, int scenario);
    // constructor
    lateralControllerVREP() : lkasModel(0.135L, 0.42L, 2.2L, 0.55L, 0.21L){
        // initialize member variables
        fill(m_input.begin(), m_input.end(), 0.0L); // m_input is the input of the last sampling period.
        m_desired_steering_angle = 0.0L;
        // controller design time parameters	
	period_s = {0.040, 0.025, 0.035, 0.040, 0.020, 0.030, 0.020, 0.020, 0.040}; 	//!< sampling period h in seconds for each scenario s_i
	tau_s = {0.0379, 0.0206, 0.0303, 0.0373, 0.0164, 0.0299, 0.0198, 0.0160, 0.0359}; //!< sensor-to-actuator delay in seconds for each scenario s_i
	if (period_s.size() != tau_s.size())
		throw range_error("In lateralControllerVREP, size of vectors period_s and tau_s should be the same");
        // Eigen::Matrix<typename Scalar, int RowsAtCompileTime, int ColsAtCompileTime>
        ///// VALUES ARE CONSIDERING ACTUATE DELAY //////////
        /////////////////////////////////////////////////////////////// v0 ////////////////////////////////////////////////////////////////////////////
        m_phi_aug[0] <<
            0.065327631161289923,   -0.0057488315421935186,   0,   0,   0,   0.75511882786638584,
             0,   0.065327631161289923,   0,   0,   0,   4.1968682178421188,
             -0.013703164614691236,   -0.0080272205354882439,   1,   0.088000000000000009,   0.0038720000000000009,   -0.10632228926224048,
             0,   -0.013703164614691236,   0,   1,   0.088000000000000009,   -0.13699382535758189,
             0,   0,   0,   0,   1,   0,
             0,   0,   0,   0,   0,   0;
        m_K2c[0] <<
            -0.62397391877152453,   -0.52567914320271902,   -1.5354539127918503,   0.097085698092269371,   -0.29128636940792801; // Q = 7.5
            // -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
            // -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
            //-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.
        m_T[0] <<
            -1.1102230246251565e-16,   2.7755575615628914e-17,   5.5511151231257827e-17,   -8.3266726846886741e-17,   1,   2.6020852139652106e-18,
             -0.47475744722592139,   0.088555558442959814,   -0.64042136878447598,   0.59713733247587453,   -1.1102230246251565e-16,   0.0071243203323152985,
             0.85635104924195504,   -0.15630738386514703,   -0.42396194435262025,   0.24951475378994095,   0,   -0.0151505641257129,
             -0.099030867483337393,   -0.02595045811430452,   -0.63958956615482654,   -0.76121421589988514,   0,   0.031584258531100459,
             0.13225883074994954,   0.80211454016338712,   -0.032275546684635024,   -0.041496231650383235,   0,   -0.57996225566165915,
             0.11818940620835439,   0.56891541814247282,   -0.00046486240233698423,   -0.00061161710466062301,   0,   0.81385866161598119;
        m_Gamma_aug[0] <<
             0.14522104608886258,
             0.69903466655112556,
             -0.00057118320939653436,
             -0.0007515028511783712,
             0,
             1;

        /////////////////////////////////////////////////////////////// v1 ////////////////////////////////////////////////////////////////////////////
        m_phi_aug[1] <<
             0.18173374202393422,   -0.0099953558113163761,   0,   0,   0,   0.53525278567264467,
             0,   0.18173374202393422,   0,   0,   0,   2.9280821229111305,
             -0.011996542965771949,   -0.0067771168753804597,   1,   0.055000000000000007,   0.0015125000000000004,   -0.049847834613823833,
             0,   -0.011996542965771949,   0,   1,   0.055000000000000007,   -0.064976359746647269,
             0,   0,   0,   0,   1,   0,
             0,   0,   0,   0,   0,   0;
        // v1 q=7.5
        m_K2c[1] <<
            -0.88193123106981275,   -0.51246248360633739,   -1.5180748761624558,   0.057711239593023871,   -0.13536736772744271; // Q = 7.5
            //-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5
        m_T[1] <<
            5.2735593669694936e-16,   -9.540979117872439e-17,   5.5511151231257827e-16,   -5.5511151231257827e-16,   1.0000000000000002,   -1.1492543028346347e-17,
             -0.15829882477743781,   0.030471819519215827,   -0.74564102496549045,   0.64654718639567332,   8.8817841970012523e-16,   0.0030245564173626569,
             0.9450056377546342,   -0.17756249963016604,   -0.26550162072370398,   -0.066343910924665406,   0,   -0.023308329269832437,
             -0.22216447881148454,   0.0073923778074767646,   -0.61030754308530177,   -0.75881461022445995,   0,   0.048097684641321095,
             0.076943528209384215,   0.57994019258310947,   -0.032420792936974092,   -0.042097992721594278,   0,   -0.80927480974481603,
             0.1631823045159988,   0.79445437422000076,   -0.0013951057377869919,   -0.0018350928510219243,   0,   0.58498587067532082;
        m_Gamma_aug[1] <<
            0.27895084769759904,
             1.3580744664873099,
             -0.002384853733606336,
             -0.0031369866231186956,
             0,
             1;
        /////////////////////////////////////////////////////////////// v2 ////////////////////////////////////////////////////////////////////////////
        m_phi_aug[2] <<
             0.091877632704218226,   -0.0070745777182248011,   0,   0,   0,   0.58789705801260816,
             0,   0.091877632704218226,   0,   0,   0,   3.320168657642629,
             -0.01331391694482047,   -0.0076964103967119704,   1,   0.077000000000000013,   0.002964500000000001,   -0.085064267891422518,
             0,   -0.01331391694482047,   0,   1,   0.077000000000000013,   -0.1100375309700076,
             0,   0,   0,   0,   1,   0,
             0,   0,   0,   0,   0,   0;
        // q=10
        m_K2c[2] <<
            -0.84207143307875287,   -0.57593339347966044,   -1.7034034808299066,   0.097052677524010714,   -0.19637786882115901; // Q = 10
            //-0.55384827844383655,   -0.4049400023031392,   -1.3381579348303918,   0.07798629268032041,   -0.15594781780844005; // Q = 5
        m_T[2] <<
            0,   0,   -1.1102230246251565e-16,   1.1102230246251565e-16,   0.99999999999999989,   0,
             -0.38298560790502523,   0.070696252185571989,   -0.6798296697058448,   0.62130489141045964,   1.6653345369377348e-16,   0.011658308694278963,
             0.89931191023833812,   -0.16185277328128389,   -0.36630545698608219,   0.17257795336585036,   0,   -0.03284707108557372,
             -0.11434981885795774,   -0.028150150618974253,   -0.63338453171851783,   -0.76163990328209419,   0,   0.069716430311927632,
             0.062664651926771564,   0.55942092149528,   -0.04973577525088968,   -0.064013481914928366,   0,   -0.82252659579225074,
             0.16600413418688897,   0.80935870991889147,   -0.00152315782713991,   -0.0020034428020378053,   0,   0.56336025092161213;
        m_Gamma_aug[2] <<
            0.29466781498218869,
             1.4366627900971813,
             -0.00270370127222882,
             -0.0035562374142661534,
             0,
             1;

        /////////////////////////////////////////////////////////////// v3 ////////////////////////////////////////////////////////////////////////////
        m_phi_aug[3] <<
            0.065327631161289923,   -0.0057488315421935186,   0,   0,   0,   0.71785657450402329,
             0,   0.065327631161289923,   0,   0,   0,   4.0148565237622496,
             -0.013703164614691236,   -0.0080272205354882439,   1,   0.088000000000000009,   0.0038720000000000009,   -0.10596167842061979,
             0,   -0.013703164614691236,   0,   1,   0.088000000000000009,   -0.13651942861745828,
             0,   0,   0,   0,   1,   0,
             0,   0,   0,   0,   0,   0;
            // q=7.5
        m_K2c[3] <<
            -0.6184073252564849,   -0.5300398617887363,   -1.537319501186567,   0.11280744825313978,   -0.26602407395228445; // Q = 7.5
            //-0.29249027996323107,   -0.28549560532646351,   -1.056563344205941,   0.079929179840173781,   -0.18633734617443931; // Q = 2.5
        m_T[3] <<
            1.9428902930940239e-16,   -3.4694469519536142e-17,   8.3266726846886741e-17,   -1.1102230246251565e-16,   1.0000000000000002,   -3.0357660829594124e-18,
             -0.48980748824481296,   0.090792803129477906,   -0.63372615433876467,   0.59173114472942479,   -1.6653345369377348e-16,   0.0095239184900154945,
             0.84836741729435339,   -0.15369700268421155,   -0.43275261732926928,   0.26267025179528974,   0,   -0.019479929560037967,
             -0.095365160475563648,   -0.029335200635560429,   -0.64010268618650101,   -0.76063985076365304,   0,   0.041719308937409147,
             0.11342105883792242,   0.73369080380008,   -0.037207590989503228,   -0.047799352588359899,   0,   -0.66720632857922468,
             0.13565581193657117,   0.65495889083868852,   -0.00069268409179653559,   -0.00091131848728562552,   0,   0.74338754474805935;
        m_Gamma_aug[3] <<
            0.18248329945122513,
             0.88104636063099484,
             -0.0009317940510172153,
             -0.0012258995913019763,
             0,
             1;

        /////////////////////////////////////////////////////////////// v4 ////////////////////////////////////////////////////////////////////////////
        m_phi_aug[4] <<
            0.25559270561048886,   -0.011246079046861503,   0,   0,   0,   0.5168213115778022,
             0,   0.25559270561048886,   0,   0,   0,   2.7588051371585101,
             -0.010913701993855197,   -0.0061084728899776829,   1,   0.044000000000000004,   0.00096800000000000033,   -0.034762555942966282,
             0,   -0.010913701993855197,   0,   1,   0.044000000000000004,   -0.045458117503249143,
             0,   0,   0,   0,   1,   0,
             0,   0,   0,   0,   0,   0;
        // q=7.5
        m_K2c[4] <<
            -0.95110188997833811,   -0.61561969311372244,   -1.4775762592233532,   0.044675898224614784,   -0.12187996545770939; // Q = 7.5
            //-0.46487306713255255,   -0.39591077537968483,   -0.99753184127862682,   0.031201430643079647,   -0.083594546113972892; // Q = 2.5
        m_T[4] <<
            -1.3183898417423734e-16,   2.0816681711721685e-17,   -4.4408920985006262e-16,   4.4408920985006262e-16,   1,   1.8431436932253575e-18,
             -0.091105049428403931,   0.018005721983769107,   -0.7610344102258737,   0.64202900123598605,   -6.106226635438361e-16,   0.0010256551907126441,
             0.92532583094281007,   -0.17900237856649326,   -0.27494271004211257,   -0.18955726640764736,   0,   -0.014310974959609596,
             -0.31916687297022861,   0.03555489519404971,   -0.58717037421602969,   -0.742345832195486,   0,   0.031968323245758087,
             0.1006518450726403,   0.64365937814199037,   -0.021516608754543354,   -0.028062996665083606,   0,   -0.75783990049298589,
             0.15321125885692899,   0.7430157446521487,   -0.0010582237794158681,   -0.0013921078080103727,   0,   0.65149892982012714;
        m_Gamma_aug[4] <<
            0.23516732237646079,
             1.1404711667865495,
             -0.0016242908943964556,
             -0.0021367768146522063,
             0,
             1;

        /////////////////////////////////////////////////////////////// v5 ////////////////////////////////////////////////////////////////////////////
        m_phi_aug[5] <<
            0.12921790123523191,   -0.0085283814815253108,   0,   0,   0,   0.84794087592968148,
             0,   0.12921790123523191,   0,   0,   0,   4.5256328725699833,
             -0.012766473943939857,   -0.0072906751467964239,   1,   0.066000000000000003,   0.0021779999999999998,   -0.069468959172125977,
             0,   -0.012766473943939857,   0,   1,   0.066000000000000003,   -0.090269068411321665,
             0,   0,   0,   0,   1,   0,
             0,   0,   0,   0,   0,   0;
            // q=10
        m_K2c[5] <<
            -0.96495124373293695,   -0.58491186720334754,   -1.6795741651034997,   -0.059366367563748586,   -0.30289233138221594; // Q = 10
            //-0.63522128039691028,   -0.43222747563713443,   -1.3136448099423239,   -0.046596736146638111,   -0.2393966050959451; // Q = 5

        m_T[5] <<
            -2.4980018054066022e-16,   4.8572257327350599e-17,   -5.5511151231257827e-17,   1.6653345369377348e-16,   0.99999999999999978,   1.2197274440461925e-19,
             -0.18699841710481804,   0.036661562015827896,   -0.73684778394137807,   0.64864694299259806,   -3.3306690738754696e-16,   9.2292414906706191e-05,
             0.94146268981516168,   -0.18145820175763722,   -0.28154032218865116,   -0.038152859251363747,   0,   -0.00057533793636510414,
             -0.21166159266058079,   0.014959828772432713,   -0.61445969465927408,   -0.75987746456700322,   0,   0.0010469947181181293,
             0.18391081157379069,   0.98195666598343556,   -0.01515499653546663,   -0.019691153276352878,   0,   -0.036338740754496585,
             0.0074685517303334503,   0.035583149653162872,   -1.3536970547688187e-06,   -1.7811800422835646e-06,   0,   0.99933881151029402;
        m_Gamma_aug[5] <<
             0.0074734931179610258,
             0.03560669238832654,
             -1.3545926958675663e-06,
             -1.7823585172196795e-06,
             0,
             1;

        /////////////////////////////////////////////////////////////// v6 ////////////////////////////////////////////////////////////////////////////
        m_phi_aug[6] <<
            0.25559270561048886,   -0.011246079046861503,   0,   0,   0,   0.73710023006681213,
             0,   0.25559270561048886,   0,   0,   0,   3.8283049606902209,
             -0.010913701993855197,   -0.0061084728899776829,   1,   0.044000000000000004,   0.00096800000000000033,   -0.036381440748273965,
             0,   -0.010913701993855197,   0,   1,   0.044000000000000004,   -0.047587781047461898,
             0,   0,   0,   0,   1,   0,
             0,   0,   0,   0,   0,   0;
        // q=7.5
        m_K2c[6] <<
            -0.95181231457974824,   -0.71343342760940276,   -1.4354752996126372,   -0.036746134286983839,   -0.18660767454484228; // Q = 7.5
            //-0.46554971227596326,   -0.4654602657211161,   -0.96898250924162621,   -0.024911592813389019,   -0.12797956522986562; // Q = 2.5
        m_T[6] <<
            -1.2490009027033011e-16,   3.6429192995512949e-17,   -7.2164496600635175e-16,   6.106226635438361e-16,   0.99999999999999989,   1.1180834903756764e-19,
             -0.070319735293446109,   0.014218920849754247,   -0.7651818917500357,   0.63980436712689637,   -9.4368957093138306e-16,   3.8227167981963244e-05,
             0.89889995366232811,   -0.17915187817636319,   -0.30355571512737867,   -0.26026323989943828,   0,   -0.00067202849578205199,
             -0.38902450045243941,   0.060303258348354337,   -0.56768038102877505,   -0.7230215613962262,   0,   0.0015039386586098726,
             0.18834394377951019,   0.97931371936543099,   -0.0094649520492386448,   -0.012378993021560217,   0,   -0.072307490059500643,
             0.014849411551794311,   0.070785471185602425,   -5.3919306845558602e-06,   -7.0946409724710094e-06,   0,   0.99738102647192506;
        m_Gamma_aug[6] <<
            0.014888403887450804,
             0.070971343254838767,
             -5.4060890887697624e-06,
             -7.1132704394499669e-06,
             0,
             1;
        /////////////////////////////////////////////////////////////// v7 ////////////////////////////////////////////////////////////////////////////
        m_phi_aug[7] <<
            0.25559270561048886,   -0.011246079046861503,   0,   0,   0,   0.49458306274350478,
             0,   0.25559270561048886,   0,   0,   0,   2.6485193398013007,
             -0.010913701993855197,   -0.0061084728899776829,   1,   0.044000000000000004,   0.00096800000000000033,   -0.034398840046074138,
             0,   -0.010913701993855197,   0,   1,   0.044000000000000004,   -0.044979771579249622,
             0,   0,   0,   0,   1,   0,
             0,   0,   0,   0,   0,   0;
        // q=7.5
        m_K2c[7] <<
            -0.95097843305887209,   -0.60560424490296871,   -1.4813630861567724,   0.041661453168528401,   -0.1153367588369735; // Q = 7.5
            //-0.46477141465361482,   -0.38867121192261134,   -1.0000986318914686,   0.029183424068099584,   -0.079108432008016372; // Q = 2.5
        m_T[7] <<
            -7.6327832942979512e-17,   1.214306433183765e-17,   -3.8857805861880479e-16,   3.3306690738754696e-16,   1,   2.1684043449710089e-19,
             -0.09386772087159681,   0.018498996576298356,   -0.76050124585266432,   0.64224845059437263,   -3.8857805861880479e-16,   0.001192002397203244,
             0.92773072801125034,   -0.17880493066639083,   -0.27223189576360585,   -0.18158351524665206,   0,   -0.016177607756546697,
             -0.31154787217882779,   0.032671640163212459,   -0.58903927036764259,   -0.74403752303236093,   0,   0.036213113018831705,
             0.090861378939940618,   0.60987086336583873,   -0.023640761439797198,   -0.030820761570857346,   0,   -0.78631605279892214,
             0.15870312044841728,   0.77115282392111451,   -0.001225703390047526,   -0.0016123510343131759,   0,   0.61654889481189412;
        m_Gamma_aug[7] <<
            0.25740557121075819,
             1.250756964143759,
             -0.0019880067912885998,
             -0.0026151227386517271,
             0,
             1;

        /////////////////////////////////////////////////////////////// v8 ////////////////////////////////////////////////////////////////////////////
        m_phi_aug[8] <<
            0.065327631161289923,   -0.0057488315421935186,   0,   0,   0,   0.63748385641031935,
             0,   0.065327631161289923,   0,   0,   0,   3.6180414250245341,
             -0.013703164614691236,   -0.0080272205354882439,   1,   0.088000000000000009,   0.0038720000000000009,   -0.10480932520253905,
             0,   -0.013703164614691236,   0,   1,   0.088000000000000009,   -0.13500377300830319,
             0,   0,   0,   0,   1,   0,
             0,   0,   0,   0,   0,   0;
        // q=7.5
        m_K2c[8] <<
           -0.60429993094857071,   -0.54183010883723348,   -1.540993338516621,   0.11359771723058523,   -0.21762344775008163; // Q = 7.5
            //-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
        m_T[8] <<
            0,   3.4694469519536142e-18,   5.5511151231257827e-17,   -5.5511151231257827e-17,   1,   1.7347234759768071e-18,
             -0.52544480306876074,   0.095962820749133024,   -0.61685356732006003,   0.57787655918822767,   -5.5511151231257827e-17,   0.015787805015010242,
             0.82780731677327313,   -0.14730041921542808,   -0.45400060333074843,   0.2933435630315796,   0,   -0.029506592464177174,
             -0.086905413669316214,   -0.037577606599499949,   -0.640910656707393,   -0.75876205270994246,   0,   0.067446645902602465,
             0.074292810834294287,   0.60278378571697944,   -0.051059291258072466,   -0.065464510100793655,   0,   -0.79008837013876643,
             0.15990882576634013,   0.77738880535533095,   -0.0012678939049535561,   -0.001667828939102597,   0,   0.60835139807673433;
        m_Gamma_aug[8] <<
            0.26285601754492899,
             1.2778614593687103,
             -0.0020841472690979672,
             -0.0027415552004570647,
             0,
             1;
    }
    // destructor
    ~lateralControllerVREP(){
    }
};

#endif
